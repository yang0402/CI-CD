name: Docker 部署流水线 (适配阿里云 ACR)

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      environment:
        description: '选择部署环境'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 10  # 整个任务最多运行 10 分钟
    permissions:
      contents: read
      packages: write

    steps:
      - name: 显示仓库所有者
        run: |
          echo "仓库所有者是: ${{ github.repository_owner }}"

      - name: 检出代码
        uses: actions/checkout@v3
        timeout-minutes: 2

      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v2
        timeout-minutes: 1

      - name: 配置缓存
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: 登录到阿里云 ACR
        uses: docker/login-action@v2
        with:
          registry: crpi-jus3outykfqe01tn.cn-hangzhou.personal.cr.aliyuncs.com
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: 构建并推送 Docker 镜像到阿里云 ACR
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            crpi-jus3outykfqe01tn.cn-hangzhou.personal.cr.aliyuncs.com/ty0402/simple-flask-app:latest
            crpi-jus3outykfqe01tn.cn-hangzhou.personal.cr.aliyuncs.com/ty0402/simple-flask-app:${{ github.sha }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: 更新缓存
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: 部署到服务器
        uses: appleboy/ssh-action@v0.1.10
        env:
          OWNER: ${{ github.repository_owner }}
          IMAGE_TAG: ${{ github.sha }}
          ACR_REGISTRY: crpi-jus3outykfqe01tn.cn-hangzhou.personal.cr.aliyuncs.com
          ACR_NAMESPACE: ty0402
        with:
          host: 118.31.6.172
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: OWNER,IMAGE_TAG,ACR_REGISTRY,ACR_NAMESPACE
          command_timeout: 20m
          script: |
            set -e
            
            echo "🚀 开始部署 - $(date)"
            
            # 检查环境变量
            if [ -z "${IMAGE_TAG}" ]; then exit 1; fi
            if [ -z "${ACR_REGISTRY}" ]; then exit 1; fi
            if [ -z "${ACR_NAMESPACE}" ]; then exit 1; fi

            # 如果没有安装 Docker，则安装
            if ! command -v docker &> /dev/null; then
                curl -fsSL https://get.docker.com  | sh
            fi

            # 创建 Docker 认证文件
            mkdir -p ~/.docker
            echo "{\"auths\":{\"${ACR_REGISTRY}\":{\"auth\":\"$(echo -n \"${OWNER}:${IMAGE_TAG}\" | base64)\"}}}" > ~/.docker/config.json

            # 登录阿里云 ACR
            echo "${IMAGE_TAG}" | docker login ${ACR_REGISTRY} -u "${OWNER}" --password-stdin

            # 停止并移除旧容器
            docker stop simple-flask-app || true
            docker rm simple-flask-app || true

            # 拉取新镜像
            docker pull ${ACR_REGISTRY}/${ACR_NAMESPACE}/simple-flask-app:${IMAGE_TAG}
            docker tag ${ACR_REGISTRY}/${ACR_NAMESPACE}/simple-flask-app:${IMAGE_TAG} ${ACR_REGISTRY}/${ACR_NAMESPACE}/simple-flask-app:latest

            # 启动新容器
            docker run -d \
              --name simple-flask-app \
              --restart unless-stopped \
              --log-opt max-size=10m \
              --log-opt max-file=3 \
              -p 5000:5000 \
              ${ACR_REGISTRY}/${ACR_NAMESPACE}/simple-flask-app:latest

            # 检查容器是否启动成功
            for i in {1..30}; do
              if docker ps | grep -q simple-flask-app; then break; fi
              sleep 1
            done

            # 清理未使用的镜像
            docker image prune -f

            # 删除认证信息
            rm -f ~/.docker/config.json

            echo "✅ 部署完成！- $(date)"