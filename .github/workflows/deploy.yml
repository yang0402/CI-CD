# .github/workflows/docker-deploy.yml

# `name`ï¼šå·¥ä½œæµçš„åç§°ï¼Œä¼šåœ¨ GitHub Actions é¡µé¢æ˜¾ç¤ºã€‚
name: Docker éƒ¨ç½²æµæ°´çº¿ (é€‚é…é˜¿é‡Œäº‘ ACR)

# `on`ï¼šå®šä¹‰è§¦å‘å·¥ä½œæµè¿è¡Œçš„äº‹ä»¶ã€‚
on:
  # `push` äº‹ä»¶ï¼šå½“ä»£ç æ¨é€åˆ°ä»“åº“æ—¶è§¦å‘ã€‚
  push:
    # `branches`ï¼šæŒ‡å®šåªæœ‰å½“ä»£ç æ¨é€åˆ° 'master' åˆ†æ”¯æ—¶æ‰è§¦å‘æ­¤å·¥ä½œæµã€‚
    # è¿™æ„å‘³ç€åªæœ‰ master åˆ†æ”¯çš„ä»£ç å˜æ›´æ‰ä¼šè§¦å‘éƒ¨ç½²ã€‚
    branches: [ master ]

# `jobs`ï¼šåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªä½œä¸šï¼ˆJobï¼‰çš„å®šä¹‰ã€‚
jobs:
  # å®šä¹‰ä¸€ä¸ªåä¸º 'build-and-deploy' çš„ä½œä¸šã€‚
  build-and-deploy:
    # `runs-on`ï¼šæŒ‡å®šè¿è¡Œæ­¤ä½œä¸šçš„ Runnerï¼ˆè¿è¡Œå™¨ï¼‰ç¯å¢ƒã€‚è¿™é‡Œä½¿ç”¨ GitHub æ‰˜ç®¡çš„æœ€æ–° Ubuntu ç¯å¢ƒã€‚
    runs-on: ubuntu-latest
    # `timeout-minutes`ï¼šè®¾ç½®ä½œä¸šçš„æœ€å¤§è¿è¡Œæ—¶é—´ï¼Œè¶…è¿‡æ­¤æ—¶é—´ä½œä¸šå°†è¢«å–æ¶ˆã€‚
    timeout-minutes: 10
    # `permissions`ï¼šä¸ºå½“å‰ä½œä¸šè®¾ç½®æƒé™ã€‚
    permissions:
      contents: read  # å…è®¸è¯»å–ä»“åº“å†…å®¹ï¼ˆä¾‹å¦‚æ£€å‡ºä»£ç ï¼‰
      packages: write # å…è®¸å†™å…¥ GitHub Packagesï¼ˆè™½ç„¶è¿™é‡Œæ¨é€åˆ° ACRï¼Œä½†è¿™æ˜¯æ¨èçš„å®‰å…¨å®è·µï¼‰

    # `steps`ï¼šå®šä¹‰ä½œä¸šä¸­è¦æ‰§è¡Œçš„ä¸€ç³»åˆ—æ­¥éª¤ã€‚
    steps:
      # --- æ­¥éª¤ 1: æ˜¾ç¤ºä»“åº“æ‰€æœ‰è€… (å¯é€‰ï¼Œç”¨äºè°ƒè¯•æˆ–ä¿¡æ¯å±•ç¤º) ---
      - name: æ˜¾ç¤ºä»“åº“æ‰€æœ‰è€…
        # `run`ï¼šæ‰§è¡Œ shell å‘½ä»¤ã€‚
        run: |
          echo "ä»“åº“æ‰€æœ‰è€…æ˜¯: ${{ github.repository_owner }}"

      # --- æ­¥éª¤ 2: æ£€å‡ºä»£ç  ---
      - name: æ£€å‡ºä»£ç 
        # `uses`ï¼šä½¿ç”¨ `actions/checkout@v3` Action æ¥å…‹éš†ä»“åº“ä»£ç åˆ° Runnerã€‚
        # è¿™æ˜¯æ‰€æœ‰åŸºäºä»£ç çš„æ“ä½œçš„å¿…å¤‡æ­¥éª¤ã€‚
        uses: actions/checkout@v3

      # --- æ­¥éª¤ 3: è®¾ç½® Python ç¯å¢ƒå¹¶è¿è¡Œæµ‹è¯• ---
      # è¿™ä¸€æ­¥è‡³å…³é‡è¦ï¼Œå®ƒç¡®ä¿åªæœ‰é€šè¿‡æµ‹è¯•çš„ä»£ç æ‰ä¼šè¢«æ„å»ºå’Œéƒ¨ç½²ã€‚
      - name: è®¾ç½® Python ç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
        # `uses`ï¼šä½¿ç”¨ `actions/setup-python@v4` Action æ¥è®¾ç½® Python ç¯å¢ƒã€‚
        uses: actions/setup-python@v4
        with:
          python-version: '3.8' # æŒ‡å®š Python ç‰ˆæœ¬ï¼Œä¸æ‚¨æœ¬åœ°æµ‹è¯•ä½¿ç”¨çš„ç‰ˆæœ¬ä¿æŒä¸€è‡´ã€‚
      - name: å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip # å‡çº§ pip
          pip install -r requirements.txt     # å®‰è£… requirements.txt ä¸­åˆ—å‡ºçš„æ‰€æœ‰ä¾èµ–ï¼ŒåŒ…æ‹¬ pytest å’Œ Flask

      - name: è¿è¡Œ Pytest æµ‹è¯•
        # `run`ï¼šæ‰§è¡Œ pytest æµ‹è¯•ã€‚
        # å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œæ­¤æ­¥éª¤å°†å¤±è´¥ï¼Œä»è€Œé˜»æ­¢åç»­çš„ Docker é•œåƒæ„å»ºå’Œéƒ¨ç½²ã€‚
        run: |
          pytest

      # --- æ­¥éª¤ 4: è®¾ç½® Docker Buildx ---
      - name: è®¾ç½® Docker Buildx
        # `uses`ï¼šä½¿ç”¨ `docker/setup-buildx-action@v2` Action æ¥è®¾ç½® Docker Buildxã€‚
        # Buildx æ˜¯ Docker çš„ä¸€ä¸ªç»„ä»¶ï¼Œç”¨äºæ„å»ºå¤šå¹³å°é•œåƒå’Œå¯ç”¨é«˜çº§æ„å»ºåŠŸèƒ½ï¼ˆå¦‚ç¼“å­˜ï¼‰ã€‚
        uses: docker/setup-buildx-action@v2

      # --- æ­¥éª¤ 5: é…ç½®æ„å»ºç¼“å­˜ ---
      - name: é…ç½®ç¼“å­˜
        # `uses`ï¼šä½¿ç”¨ `actions/cache@v3` Action æ¥é…ç½®æ„å»ºç¼“å­˜ã€‚
        # ç¼“å­˜å¯ä»¥åŠ é€Ÿé‡å¤çš„æ„å»ºè¿‡ç¨‹ï¼Œå°¤å…¶æ˜¯ Docker é•œåƒæ„å»ºã€‚
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache # ç¼“å­˜æ–‡ä»¶çš„å­˜å‚¨è·¯å¾„ï¼Œè¿™é‡Œæ˜¯ Buildx çš„ç¼“å­˜ç›®å½•ã€‚
          key: ${{ runner.os }}-buildx-${{ github.sha }} # ç¼“å­˜çš„å”¯ä¸€é”®ï¼ŒåŒ…å«æ“ä½œç³»ç»Ÿå’Œå½“å‰ commit çš„ SHA å€¼ã€‚
                                                          # æ¯æ¬¡æ–°çš„ commit éƒ½ä¼šç”Ÿæˆæ–°çš„ç¼“å­˜ã€‚
          restore-keys: | # ç”¨äºæ¢å¤ç¼“å­˜çš„é”®åˆ—è¡¨ï¼ŒæŒ‰é¡ºåºå°è¯•ã€‚
            ${{ runner.os }}-buildx- # å¦‚æœæ‰¾ä¸åˆ°å®Œæ•´åŒ¹é…çš„ keyï¼Œä¼šå°è¯•æ¢å¤æœ€è¿‘çš„æ“ä½œç³»ç»Ÿ+Buildx ç¼“å­˜ã€‚

      # --- æ­¥éª¤ 6: ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ (ACR) - åœ¨ GitHub Actions Runner ä¸Šæ‰§è¡Œ ---
      - name: ç™»å½•åˆ°é˜¿é‡Œäº‘ ACR (Runner)
        # `uses`ï¼šä½¿ç”¨ `docker/login-action@v2` Action æ¥ç™»å½• Docker æ³¨å†Œè¡¨ã€‚
        # æ­¤ç™»å½•æ˜¯ä¸ºäº†è®© GitHub Actions Runner èƒ½å¤Ÿå°†æ„å»ºçš„é•œåƒæ¨é€åˆ° ACRã€‚
        uses: docker/login-action@v2
        with:
          registry: crpi-jus3outykfqe01tn.cn-hangzhou.personal.cr.aliyuncs.com # é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡çš„æ³¨å†Œè¡¨åœ°å€ã€‚
          username: tyæ¸å·ä»»                                                # æ‚¨çš„ ACR ç”¨æˆ·åã€‚
          password: ${{ secrets.ACR_PASSWORD }}                             # ä» GitHub Secrets è·å– ACR å¯†ç ï¼Œç¡®ä¿å®‰å…¨ã€‚

      # --- æ­¥éª¤ 7: æ„å»ºå¹¶æ¨é€ Docker é•œåƒåˆ°é˜¿é‡Œäº‘ ACR ---
      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒåˆ°é˜¿é‡Œäº‘ ACR
        # `uses`ï¼šä½¿ç”¨ `docker/build-push-action@v4` Action æ¥æ„å»º Docker é•œåƒå¹¶æ¨é€åˆ°è¿œç¨‹ä»“åº“ã€‚
        uses: docker/build-push-action@v4
        with:
          context: . # Dockerfile çš„ä¸Šä¸‹æ–‡è·¯å¾„ï¼Œ'.' è¡¨ç¤ºå½“å‰ä»“åº“æ ¹ç›®å½•ã€‚
          push: true # è®¾ç½®ä¸º true è¡¨ç¤ºæ„å»ºå®Œæˆåè‡ªåŠ¨æ¨é€é•œåƒåˆ°æ³¨å†Œè¡¨ã€‚
          tags: |    # æŒ‡å®šè¦æ¨é€çš„é•œåƒæ ‡ç­¾ï¼Œå¯ä»¥æœ‰å¤šä¸ªã€‚
            crpi-jus3outykfqe01tn.cn-hangzhou.personal.cr.aliyuncs.com/ty0402/simple-flask-app:latest
            crpi-jus3outykfqe01tn.cn-hangzhou.personal.cr.aliyuncs.com/ty0402/simple-flask-app:${{ github.sha }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      # --- æ­¥éª¤ 8: æ›´æ–°ç¼“å­˜ (å°†æ–°ç”Ÿæˆçš„ç¼“å­˜å¤åˆ¶åˆ°æ—§ç¼“å­˜ä½ç½®) ---
      - name: æ›´æ–°ç¼“å­˜
        # `run`ï¼š shell å‘½ä»¤ï¼Œç”¨äºæ›´æ–° Buildx ç¼“å­˜ã€‚
        # è¿™æ˜¯ç¼“å­˜ç®¡ç†çš„æœ€ä½³å®è·µï¼Œç¡®ä¿æ–°çš„æ„å»ºç»“æœèƒ½å¤Ÿè¢«ä¸‹æ¬¡ä½¿ç”¨ã€‚
        run: |
          rm -rf /tmp/.buildx-cache      # åˆ é™¤æ—§ç¼“å­˜ç›®å½•ã€‚
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache # å°†æ–°ç¼“å­˜ç›®å½•é‡å‘½åä¸ºæ—§ç¼“å­˜ç›®å½•ã€‚

      # --- æ­¥éª¤ 9: éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨ ---
      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        # `uses`ï¼šä½¿ç”¨ `appleboy/ssh-action@v0.1.10` Action é€šè¿‡ SSH è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨å¹¶æ‰§è¡Œå‘½ä»¤ã€‚
        uses: appleboy/ssh-action@v0.1.10
        # `env`ï¼šå®šä¹‰åœ¨æ­¤æ­¥éª¤ä¸­å¯ç”¨çš„ç¯å¢ƒå˜é‡ã€‚
        env:
          OWNER: ${{ github.repository_owner }} # ä»“åº“æ‰€æœ‰è€…ã€‚
          IMAGE_TAG: ${{ github.sha }}         # ä½¿ç”¨å½“å‰ commit SHA ä½œä¸ºé•œåƒæ ‡ç­¾ï¼Œç”¨äºéƒ¨ç½²æŒ‡å®šç‰ˆæœ¬ã€‚
          ACR_REGISTRY: crpi-jus3outykfqe01tn.cn-hangzhou.personal.cr.aliyuncs.com # ACR æ³¨å†Œè¡¨åœ°å€ã€‚
          ACR_NAMESPACE: ty0402                # ACR å‘½åç©ºé—´ã€‚
          ACR_USERNAME: tyæ¸å·ä»»               # ACR ç”¨æˆ·åã€‚
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }} # ACR å¯†ç ï¼ˆä» GitHub Secrets è·å–ï¼‰ã€‚
        # `with`ï¼šä¼ é€’ç»™ `appleboy/ssh-action` çš„å‚æ•°ã€‚
        with:
          host: ${{ secrets.SERVER_IP }} # ç›®æ ‡æœåŠ¡å™¨çš„ IP åœ°å€ï¼ˆä» GitHub Secrets è·å–ï¼‰ã€‚
          username: root                 # ç™»å½•æœåŠ¡å™¨çš„ç”¨æˆ·åã€‚
          key: ${{ secrets.SSH_PRIVATE_KEY }} # ç”¨äº SSH è®¤è¯çš„ç§é’¥ï¼ˆä» GitHub Secrets è·å–ï¼‰ã€‚
          envs: OWNER,IMAGE_TAG,ACR_REGISTRY,ACR_NAMESPACE,ACR_USERNAME,ACR_PASSWORD # æŒ‡å®šå“ªäº› env å˜é‡è¦ä¼ é€’åˆ°è¿œç¨‹æœåŠ¡å™¨çš„ SSH ä¼šè¯ä¸­ã€‚
          command_timeout: 20m           # SSH å‘½ä»¤æ‰§è¡Œçš„è¶…æ—¶æ—¶é—´ï¼Œé˜²æ­¢é•¿æ—¶é—´å¡ä½ã€‚
          script: |                      # è¦åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡Œçš„ Shell è„šæœ¬ã€‚
            set -e # ä»»ä½•å‘½ä»¤å¤±è´¥ç«‹å³é€€å‡ºè„šæœ¬ï¼Œç¡®ä¿éƒ¨ç½²æµç¨‹çš„åŸå­æ€§ã€‚

            echo "ğŸš€ å¼€å§‹éƒ¨ç½² - $(date)" # æ‰“å°éƒ¨ç½²å¼€å§‹æ—¶é—´ã€‚

            # æ£€æŸ¥å¿…è¦ç¯å¢ƒå˜é‡
            if [ -z "${IMAGE_TAG}" ]; then echo "âŒ IMAGE_TAG æœªè®¾ç½®"; exit 1; fi
            if [ -z "${ACR_REGISTRY}" ]; then echo "âŒ ACR_REGISTRY æœªè®¾ç½®"; exit 1; fi
            if [ -z "${ACR_NAMESPACE}" ]; then echo "âŒ ACR_NAMESPACE æœªè®¾ç½®"; exit 1; fi
            if [ -z "${ACR_USERNAME}" ]; then echo "âŒ ACR_USERNAME æœªè®¾ç½®"; exit 1; fi
            if [ -z "${ACR_PASSWORD}" ]; then echo "âŒ ACR_PASSWORD æœªè®¾ç½®"; exit 1; fi

            # å®‰è£… Dockerï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
            if ! command -v docker &> /dev/null; then
                echo "ğŸ“¦ æ­£åœ¨å®‰è£… Docker..."
                curl -fsSL https://get.docker.com | sh
            fi

            # åˆ›å»º Docker è®¤è¯æ–‡ä»¶ - åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šè¿›è¡Œ Docker ç™»å½•è®¤è¯
            echo "ğŸ” é…ç½® Docker è®¤è¯ä¿¡æ¯..."
            mkdir -p ~/.docker
            # è¿™è¡Œä»£ç ä¼šç”Ÿæˆ ~/.docker/config.json æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å« Base64 ç¼–ç çš„ç”¨æˆ·åå’Œå¯†ç ã€‚
            # Docker å®¢æˆ·ç«¯åœ¨æ‰§è¡Œ docker pull ç­‰å‘½ä»¤æ—¶ä¼šè‡ªåŠ¨è¯»å–æ­¤æ–‡ä»¶è¿›è¡Œè®¤è¯ã€‚
            echo "{\"auths\":{\"${ACR_REGISTRY}\":{\"auth\":\"$(echo -n \"${ACR_USERNAME}:${ACR_PASSWORD}\" | base64)\"}}}" > ~/.docker/config.json

            # åœæ­¢æ—§å®¹å™¨
            echo "ğŸ›‘ åœæ­¢æ—§å®¹å™¨..."
            docker stop simple-flask-app || true # åœæ­¢å®¹å™¨ï¼Œå¦‚æœå®¹å™¨ä¸å­˜åœ¨åˆ™å¿½ç•¥é”™è¯¯ã€‚
            docker rm simple-flask-app || true   # åˆ é™¤å®¹å™¨ï¼Œå¦‚æœå®¹å™¨ä¸å­˜åœ¨åˆ™å¿½ç•¥é”™è¯¯ã€‚

            # æ‹‰å–æ–°é•œåƒ (Docker ä¼šè‡ªåŠ¨ä½¿ç”¨ ~/.docker/config.json ä¸­çš„è®¤è¯ä¿¡æ¯)
            echo "â¬‡ï¸ æ‹‰å–æ–°é•œåƒ..."
            docker pull ${ACR_REGISTRY}/${ACR_NAMESPACE}/simple-flask-app:${IMAGE_TAG}
            # ä¸ºæ–°æ‹‰å–çš„é•œåƒæ·»åŠ  'latest' æ ‡ç­¾ï¼Œæ–¹ä¾¿åç»­ç®¡ç†æˆ–å›æ»šã€‚
            docker tag ${ACR_REGISTRY}/${ACR_NAMESPACE}/simple-flask-app:${IMAGE_TAG} ${ACR_REGISTRY}/${ACR_NAMESPACE}/simple-flask-app:latest

            # å¯åŠ¨æ–°å®¹å™¨
            echo "â–¶ï¸ å¯åŠ¨æ–°å®¹å™¨..."
            docker run -d \
              --name simple-flask-app \
              --restart unless-stopped \
              --log-opt max-size=10m \
              --log-opt max-file=3 \
              -p 5000:5000 \
              ${ACR_REGISTRY}/${ACR_NAMESPACE}/simple-flask-app:latest

            # ç­‰å¾…å®¹å™¨å¯åŠ¨å¹¶éªŒè¯çŠ¶æ€
            echo "ğŸ” éªŒè¯å®¹å™¨çŠ¶æ€..."
            for i in {1..30}; do # å¾ªç¯æœ€å¤š 30 ç§’ï¼Œæ£€æŸ¥å®¹å™¨æ˜¯å¦å¯åŠ¨ã€‚
              if docker ps | grep -q simple-flask-app; then
                echo "âœ… å®¹å™¨å·²å¯åŠ¨"
                break
              fi
              sleep 1
            done

            # æ¸…ç†æ— ç”¨é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æ— ç”¨é•œåƒ..."
            docker image prune -f # åˆ é™¤æ‰€æœ‰æ‚¬æŒ‚ï¼ˆæ²¡æœ‰è¢«ä»»ä½•å®¹å™¨å¼•ç”¨çš„ï¼‰çš„é•œåƒã€‚

            # åˆ é™¤è®¤è¯ä¿¡æ¯
            echo "ğŸ”’ åˆ é™¤è®¤è¯ä¿¡æ¯..."
            rm -f ~/.docker/config.json # éƒ¨ç½²å®Œæˆååˆ é™¤ä¸´æ—¶çš„è®¤è¯æ–‡ä»¶ï¼Œæé«˜å®‰å…¨æ€§ã€‚

            echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼- $(date)"