name: Docker éƒ¨ç½²æµæ°´çº¿

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 10  # æ·»åŠ ä»»åŠ¡è¶…æ—¶é™åˆ¶
    permissions:
      contents: read
      packages: write

    steps:
      - name: æ˜¾ç¤ºä»“åº“æ‰€æœ‰è€…
        run: |
          echo "ä»“åº“æ‰€æœ‰è€…æ˜¯: ${{ github.repository_owner }}"

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        timeout-minutes: 2

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v2
        timeout-minutes: 1

      - name: é…ç½®ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: ç™»å½•åˆ° GHCR
        uses: docker/login-action@v2
        timeout-minutes: 1
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: æ„å»ºå’Œæ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v4
        timeout-minutes: 10
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/simple-flask-app:latest
            ghcr.io/${{ github.repository_owner }}/simple-flask-app:${{ github.sha }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: æ›´æ–°ç¼“å­˜
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v0.1.10
        timeout-minutes: 5
        env:
          OWNER: ${{ github.repository_owner }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          IMAGE_TAG: ${{ github.sha }}
        with:
          host: 118.31.6.172
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: OWNER,GHCR_TOKEN,IMAGE_TAG
          command_timeout: 20m  # å¢åŠ å‘½ä»¤æ‰§è¡Œè¶…æ—¶æ—¶é—´
          script: |
            set -e
            
            echo "ğŸš€ å¼€å§‹éƒ¨ç½² - $(date)"
            
            # æ£€æŸ¥å¹¶å®‰è£… pv å·¥å…·ç”¨äºæ˜¾ç¤ºè¿›åº¦
            if ! command -v pv &> /dev/null; then
                apt-get update && apt-get install -y pv
            fi
            
            # ç¡®ä¿ Docker å·²å®‰è£…å¹¶è¿è¡Œ
            if ! command -v docker &> /dev/null; then
                echo "âŒ Dockeræœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
                curl -fsSL https://get.docker.com | sh
            fi
            
            # ç™»å½•åˆ° GHCR
            echo "ğŸ“¦ ç™»å½•åˆ°GHCR..."
            echo "${GHCR_TOKEN}" | docker login ghcr.io -u "${OWNER}" --password-stdin
            
            # åœæ­¢å¹¶ç§»é™¤æ—§å®¹å™¨
            echo "ğŸ›‘ æ¸…ç†æ—§å®¹å™¨..."
            docker stop simple-flask-app 2>/dev/null || true
            docker rm simple-flask-app 2>/dev/null || true
            
            # æ‹‰å–æ–°é•œåƒï¼ˆä½¿ç”¨ pv æ˜¾ç¤ºè¿›åº¦ï¼‰
            echo "â¬‡ï¸ æ‹‰å–æ–°é•œåƒ..."
            docker pull ghcr.io/${OWNER}/simple-flask-app:${IMAGE_TAG} 2>&1 | while read line; do echo "$(date '+%H:%M:%S') $line"; done
            docker tag ghcr.io/${OWNER}/simple-flask-app:${IMAGE_TAG} ghcr.io/${OWNER}/simple-flask-app:latest
            
            # å¯åŠ¨æ–°å®¹å™¨
            echo "â–¶ï¸ å¯åŠ¨æ–°å®¹å™¨..."
            docker run -d \
              --name simple-flask-app \
              --restart unless-stopped \
              --log-opt max-size=10m \
              --log-opt max-file=3 \
              -p 5000:5000 \
              ghcr.io/${OWNER}/simple-flask-app:latest
            
            # éªŒè¯å®¹å™¨æ˜¯å¦æˆåŠŸå¯åŠ¨
            echo "ğŸ” éªŒè¯å®¹å™¨çŠ¶æ€..."
            for i in {1..30}; do
              if docker ps | grep -q simple-flask-app; then
                echo "âœ… å®¹å™¨æˆåŠŸå¯åŠ¨ï¼"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "âŒ å®¹å™¨å¯åŠ¨å¤±è´¥ï¼"
                exit 1
              fi
              echo "ç­‰å¾…å®¹å™¨å¯åŠ¨... ($i/30)"
              sleep 1
            done
            
            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
            docker image prune -f
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼- $(date)"