- name: Deploy to Server
  uses: appleboy/ssh-action@v0.1.10
  env:
    OWNER: ${{ github.repository_owner }}
    GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
  with:
    host: ${{ env.SERVER_IP }}
    username: ${{ env.SERVER_USER }}
    key: ${{ env.SSH_PRIVATE_KEY }}
    script: |
      set -e

      echo "➡️ \$(date) - Starting deployment on server..."

      echo "➡️ Logging into GHCR..."
      echo "${GHCR_TOKEN}"
      echo "${GHCR_TOKEN}" | docker login ghcr.io -u "${OWNER}" --password-stdin

      echo "➡️ Stopping old container..."
      docker stop simple-flask-app || true

      echo "➡️ Removing old container..."
      docker rm simple-flask-app || true

      echo "➡️ Pulling latest image from GHCR..."
      docker pull ghcr.io/${OWNER}/simple-flask-app:latest

      echo "➡️ Starting new container..."
      docker run -d --name simple-flask-app -p 5000:5000 ghcr.io/${OWNER}/simple-flask-app:latest

      echo "✅ Deployment completed successfully!"