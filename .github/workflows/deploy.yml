name: Docker éƒ¨ç½²æµæ°´çº¿ (é€‚é…é˜¿é‡Œäº‘ ACR)

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 10  # æ•´ä¸ªä»»åŠ¡æœ€å¤šè¿è¡Œ 10 åˆ†é’Ÿ
    permissions:
      contents: read
      packages: write

    steps:
      - name: æ˜¾ç¤ºä»“åº“æ‰€æœ‰è€…
        run: |
          echo "ä»“åº“æ‰€æœ‰è€…æ˜¯: ${{ github.repository_owner }}"

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        timeout-minutes: 2

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v2
        timeout-minutes: 1

      - name: é…ç½®ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: ç™»å½•åˆ°é˜¿é‡Œäº‘ ACR
        uses: docker/login-action@v2
        with:
          registry: crpi-jus3outykfqe01tn.cn-hangzhou.personal.cr.aliyuncs.com
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒåˆ°é˜¿é‡Œäº‘ ACR
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            crpi-jus3outykfqe01tn.cn-hangzhou.personal.cr.aliyuncs.com/ty0402/simple-flask-app:latest
            crpi-jus3outykfqe01tn.cn-hangzhou.personal.cr.aliyuncs.com/ty0402/simple-flask-app:${{ github.sha }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: æ›´æ–°ç¼“å­˜
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
        uses: appleboy/ssh-action@v0.1.10
        env:
          OWNER: ${{ github.repository_owner }}
          IMAGE_TAG: ${{ github.sha }}
          ACR_REGISTRY: crpi-jus3outykfqe01tn.cn-hangzhou.personal.cr.aliyuncs.com
          ACR_NAMESPACE: ty0402
        with:
          host: 118.31.6.172
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: OWNER,IMAGE_TAG,ACR_REGISTRY,ACR_NAMESPACE
          command_timeout: 20m
          script: |
            set -e
            
            echo "ğŸš€ å¼€å§‹éƒ¨ç½² - $(date)"
            
            # æ£€æŸ¥ç¯å¢ƒå˜é‡
            if [ -z "${IMAGE_TAG}" ]; then exit 1; fi
            if [ -z "${ACR_REGISTRY}" ]; then exit 1; fi
            if [ -z "${ACR_NAMESPACE}" ]; then exit 1; fi

            # å¦‚æœæ²¡æœ‰å®‰è£… Dockerï¼Œåˆ™å®‰è£…
            if ! command -v docker &> /dev/null; then
                curl -fsSL https://get.docker.com  | sh
            fi

            # åˆ›å»º Docker è®¤è¯æ–‡ä»¶
            mkdir -p ~/.docker
            echo "{\"auths\":{\"${ACR_REGISTRY}\":{\"auth\":\"$(echo -n \"${OWNER}:${IMAGE_TAG}\" | base64)\"}}}" > ~/.docker/config.json

            # ç™»å½•é˜¿é‡Œäº‘ ACR
            echo "${IMAGE_TAG}" | docker login ${ACR_REGISTRY} -u "${OWNER}" --password-stdin

            # åœæ­¢å¹¶ç§»é™¤æ—§å®¹å™¨
            docker stop simple-flask-app || true
            docker rm simple-flask-app || true

            # æ‹‰å–æ–°é•œåƒ
            docker pull ${ACR_REGISTRY}/${ACR_NAMESPACE}/simple-flask-app:${IMAGE_TAG}
            docker tag ${ACR_REGISTRY}/${ACR_NAMESPACE}/simple-flask-app:${IMAGE_TAG} ${ACR_REGISTRY}/${ACR_NAMESPACE}/simple-flask-app:latest

            # å¯åŠ¨æ–°å®¹å™¨
            docker run -d \
              --name simple-flask-app \
              --restart unless-stopped \
              --log-opt max-size=10m \
              --log-opt max-file=3 \
              -p 5000:5000 \
              ${ACR_REGISTRY}/${ACR_NAMESPACE}/simple-flask-app:latest

            # æ£€æŸ¥å®¹å™¨æ˜¯å¦å¯åŠ¨æˆåŠŸ
            for i in {1..30}; do
              if docker ps | grep -q simple-flask-app; then break; fi
              sleep 1
            done

            # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
            docker image prune -f

            # åˆ é™¤è®¤è¯ä¿¡æ¯
            rm -f ~/.docker/config.json

            echo "âœ… éƒ¨ç½²å®Œæˆï¼- $(date)"